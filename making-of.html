<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desarrollo del proyecto Delilah Restó</title>
    <link rel="stylesheet" href="public/styles/style.css">
    <link rel="stylesheet" href="public/styles/making-of.css">
</head>
<body>
    <nav>
        <ul class="menu">
            <li><a href="#model">Modelo</a></li>
            <li><a href="#controller">Controlador</a></li>
            <li><a href="#routes">Rutas</a></li>
            <li><a href="#auth">Autenticación</a></li>
            <li><a href="https://github.com/jyongkim/delilahResto" target="_blank" title="GitHub">+</a></li>
        </ul>
    </nav>
    <header id="header">
        <h1>Delilah Restó</h1>
        <p>Desarrollo API REST</p>
    </header>
    <section>
        <header class="header">
            <h1>Utilidades</h1>
        </header>
        <ul class="container">
            <li><strong>Historial de cambios</strong>
                <ul class="gloss">
                    <li>commit f7c2cccb368277663db0b291a635140bb6445dc4
                        <strong>Autor: </strong> Jonathan Kim 
                        <em>Fecha:</em>   Sat Apr 10 16:30:34 2021 -0300
                            <span>
                        
                            Realización del proceso de trabajo
                        
                            </span>
                        </li>
                        <li>commit f0e76c31f7eb19e2ea59f4d1e9ed14bb136b5a25
                        <strong>Autor: </strong> Jonathan Kim 
                        <em>Fecha:</em>   Tue Mar 30 15:17:13 2021 -0300
                            <span>
                        
                            Historial de cambios
                        
                            </span>
                        </li>
                        <li>commit d508966b1e6be15f4cdef8e0d0f5fefa344b82bf
                        <strong>Autor: </strong> Jonathan Kim 
                        <em>Fecha:</em>   Tue Mar 23 16:12:41 2021 -0300
                            <span>
                        
                            Revisión del proyecto: modificación de órdenes y actualización de la documentación
                        
                            </span>
                        </li>
                        <li>commit e30b982e81f87017d04c8e74f77a895d77363e0d
                        <strong>Autor: </strong> Jonathan Kim 
                        <em>Fecha:</em>   Thu Mar 11 18:03:13 2021 -0300
                            <span>
                        
                            Documentación con Swagger
                        
                            </span>
                        </li>
                        <li>commit c9a28485d89b116021ff87b220ac5c799b5d659a
                        <strong>Autor: </strong> Jonathan Kim 
                        <em>Fecha:</em>   Thu Mar 4 16:00:06 2021 -0300
                            <span>
                        
                            Actualización de usuario                      
                            </span>
                        </li>
                        <li>commit f63f0ad32ea14c9be422335bf76892c0d5a0ad08
                        <strong>Autor: </strong> Jonathan Kim 
                        <em>Fecha:</em>   Thu Mar 4 15:32:23 2021 -0300
                            <span>
                        
                            Database connection
                        
                            </span>
                        </li>
                        <li>commit 3dc4581cd91a5ada4e7e7dbd48e3c2975595a533
                        <strong>Autor: </strong> Jonathan Kim 
                        <em>Fecha:</em>   Thu Mar 4 15:27:18 2021 -0300
                            <span>
                        
                            JWToken
                        
                            </span>
                        </li>
                        <li>commit 47734fa0baf6872e0b09e0bf484e2587bbb5e501
                        <strong>Autor: </strong> Jonathan Kim 
                        <em>Fecha:</em>   Tue Mar 2 16:12:27 2021 -0300
                            <span>
                        
                            Carga de producto
                        
                            </span>
                        </li>
                        <li>commit f4acba7afef278539fb11095c3832b54a524e1cc
                        <strong>Autor: </strong> Jonathan Kim 
                        <em>Fecha:</em>   Mon Feb 22 14:36:53 2021 -0300
                            <span>
                        
                            Agregar usuario
                        
                            </span>
                        </li>
                        <li>commit fbb84bb5d513f27b1f46ef6d37a6ee964cf35db6
                        <strong>Autor: </strong> Jonathan Kim 
                        <em>Fecha:</em>   Sat Feb 20 12:01:38 2021 -0300
                            <span>
                        
                            Crear usuarios y actualizar
                        
                            </span>
                        </li>
                        <li>commit 78c199424498b8c3c7e1c2ba6d7c8fe80fc5280e
                        <strong>Autor: </strong> Jonathan Kim 
                        <em>Fecha:</em>   Thu Feb 18 17:07:29 2021 -0300
                            <span>
                        
                            Consulta por ID y eliminar usuario
                        
                            </span>
                        </li>
                        <li>commit 9c93959b5b3ff36a120cb7b0b565d60032f7d1d1
                        <strong>Autor: </strong> Jonathan Kim 
                        <em>Fecha:</em>   Sat Feb 13 13:29:25 2021 -0300
                            <span>
                        
                            Estructura MC
                        
                            </span>
                        </li>
                        <li>commit a48c2351b3ba83e63c8f5dfa769349ae0b8cd1e2
                        <strong>Autor: </strong> Jonathan Kim 
                        <em>Fecha:</em>   Tue Feb 9 16:02:48 2021 -0300
                            <span>
                        
                            Inserción de datos
                        
                            </span>
                        </li>
                        <li>commit a94f05e519269ac7868fddb183a4cc3f8a679948
                        <strong>Autor: </strong> Jonathan Kim 
                        <em>Fecha:</em>   Sat Feb 6 13:11:58 2021 -0300
                            <span>
                        
                            Tablas de la base de datos
                        
                            </span>
                        </li>
                        <li>commit 3f0c00b366dbf9bdc74c3a3a5b97136d1fb865d6
                        <strong>Autor: </strong> Jonathan Kim 
                        <em>Fecha:</em>   Fri Feb 5 16:00:23 2021 -0300
                            <span>
                        
                            Conexión con el servidor
                            </span>
                        </li>
                </ul>
            </li>
            <li><strong>Herramientas</strong>
                <ul>   
                    <li><a href="https://code.visualstudio.com" target="_blank">VSCode</a></li>
                    <li><a href="" target="_blank">NodeJS</a></li>
                    <li><a href="" target="_blank">Express</a></li>
                    <li><a href="" target="_blank">MySQL</a></li>
                    <li><a href="" target="_blank">JWT</a></li>
                    <li><a href="" target="_blank">Postman</a></li>
                    <li><a href="" target="_blank">Swagger</a></li>
                </ul>
            </li>
        </ul>
    </section>
    <section id="model">
        <h2>Modelo</h2>
        <p>En esta sección se manejan las funciones definidas con Express para manipular la estructura de la base de datos. Esto está ligado directamente a las definiciones de los datos en las tablas, además, se manejan clases en formato de funciones para facilitar la asignación de los datos.</p>
        <ul>
            <li> Lo primero que se definió fue la conexión con la base de datos. La misma se encuentra en un archivo llamado dbConn.js</li>
            <li>Una vez definida la conexión, se crearon las clases con los nombres de las tablas (User, Product, Order, Cart) donde se especifican, en formato de objeto, los campos que debe completar el usuario.</li>
            <li>Luego, se definieron los métodos para la manipulación de datos (CRUD) separando las funciones en base a los parámetros necesitados (id, formData, result) para luego devolver la información resultante mediante callbacks.</li>
            <li>Por último, se exporta la clase correspondiente con todos sus métodos.</li>
        </ul>
        <label class="button" for="verModel">Ver ejemplo...</label>
        <input type="checkbox" id="verModel">
        <pre class="mostrar">
            <i class="orange"> src/middleware/dbconn.js </i>
                <i class="orange"> /* dependencies */ </i>
                    const mysql = require(`mysql`)
                <i class="orange"> /* Environment DB connection */ </i>
                const dbConn = mysql.createConnection({
                    host : `localhost`,
                    user : `root`,
                    password : ``,
                    database : `delilah`
                    } )
                    dbConn.connect(function(err) {
                    if (err) throw err;
                    console.log(`Acceso concedido.`);
                    } )
                <i class="orange"> /* connection export */ </i>
                module.exports = dbConn
            <i class="orange"> src/model/user.js </i>
                <i class="orange"> /* Import database connection */ </i>
                    let dbConn = require(`../middleware/dbConn`);
                <i class="orange"> /*  User model constructor */ </i>
                    let User = function(user) {
                        this.name = user.name
                        this.user = user.user
                        this.email = user.email
                        this.pass = user.pass
                        this.phone = user.phone
                        this.address = user.address
                        this.admin = user.admin ? user.admin : false
                    }
                <i class="orange"> /*  MySQL user methods (query, params, callback) */ </i>
                    User.create = (newUser, result) => {
                        dbConn.query(`INSERT INTO Users SET ?`, 
                        newUser, (err, res) => (err) ? result(err, null) : result(null, res)
                    )   }
                    User.list = (result) => {
                        dbConn.query(`SELECT * FROM Users`, 
                        (err, res)=> (err) ? result(null, err) : result(null, res)
                    )   }
                    User.login = (user, pass, result) => {
                        dbConn.query(`SELECT * FROM users 
                            WHERE user = ? AND pass = ?`,
                        [ user, pass ], (err, res) => (err) ? result(err, null) : result(null, res)
                    )   }
                    User.find = (id, result) => {
                        dbConn.query(`SELECT * FROM Users 
                            WHERE id_user = ? OR user = ?`, 
                        [ id, id ], (err, res) => (err) ? result(err, null) : result(null, res)
                    )   }
                    User.update = (id, user, result) => {
                        dbConn.query(`UPDATE Users SET ? 
                            WHERE id_user = ?`, 
                        [ user, id ], (err, res) => (err) ? result(err, null) : result(null, res)
                    )   }
                    User.delete = (id, result) => {
                        dbConn.query(`DELETE FROM Users 
                            WHERE id_user = ? OR user = ?`, 
                        [ id, id ], (err, res) => (err) ? result(null, err) : result(null, res)
                    )   }
                <i class="orange"> /* export User model */ </i>
                    module.exports  = User
        </pre>
    </section>
    <section id="controller">
        <h2>Controlador</h2>
        <p> En este apartado se definen las funciones que administran los métodos mencionados anteriormente (CRUD). Estas reciben parámetros a través de la URL y en base a éstos definen las acciones que se llevarán a cabo.</p>
        <ul>
            <li>Primero se realizó la importanción de las clases creadas anteriormente para su correcta manipulación.</li>
            <li>Luego, se definieron nuevas funciones para manipular el modelo. Las mismas reciben nombres similares a los definidos en el modelo y su objetivo es recuperar el resultado de la manipulación de los datos.</li>
            <li>Por último, se exportaron todos estos métodos para que sean accesibles a través de las rutas.</li>
        </ul>
        <label class="button" for="verController">Ver ejemplo...</label>
        <input type="checkbox" id="verController">
        <pre class="mostrar">
            <i class="orange"> src/controller/user.js </i>
                <i class="orange"> /* User model import */ </i>
                    const User = require(`../model/user`)
                <i class="orange"> /*  NodeJS user handler methods   */ </i>
                    exports.create = function(req, res) {
                        const newUser = new User(req.body);
                        (req.body.constructor == Object && Object.keys(req.body) == 0) ?
                            res.status(400).send(   {
                                error:true,
                                message:`Todos los campos son obligatorios.`
                            }   ) : User.create(newUser, (err, user) => err ? res.send(err) : res.json( {
                                error:false,
                                message:`Usuario agregado con éxito.`,
                                data: user
                            }   )
                    )   }
                    exports.list = function(req, res) {
                        User.list( (err, user) => (err) ? res.send(err) : res.send(user)
                    )   }
                    exports.find = function(req, res) {
                        User.find(req.params.id, (err, user) => (err) ? res.send(err) : res.json(user)
                    )   }
                    exports.update = function(req, res) {
                        (req.body.constructor == Object && Object.keys(req.body).length == 0) ?
                            res.status(400).send(   {
                                error: true,
                                message: `Debes completar todos los campos.`
                            }   ) : User.update(req.params.id, new User(req.body), (err, user) => (err) ? res.send(err): res.json( {   
                                message: `Los datos fueron actualizados.`,
                                user: user   
                            }  )
                    )   }
                    exports.delete = function(req, res) {
                        User.delete(req.params.id, (err, user) => (err) ? res.send(err) : res.json(   {
                            error:false, 
                            message:`El usuario fue eliminado.`,
                            user: user
                        }   )
                    )   }
        </pre>
    </section>
    <section id="routes">
        <h2>Rutas</h2>
        <p>Representan las direcciones a las cuales deberá acceder el usuario para poder mostrar o enviar determinada información. Gracias al framework de Express podemos especificar las rutas como strings además del método a utilizar para las consultas HTTP (POST, GET, PUT, DELETE). Las mismas fueron verificadas con Postman.</p>
        <ul>
            <li>Primero, se importaron los controladores previamente mencionados.</li>
            <li>Luego, se defineron los métodos asociados a cada controlador. Por ejemplo: en el caso de User.create corresponde el método POST, en el de User.find corresponde el método GET.</li>
            <li>Luego, se definieron las direcciones, conjuntamente con los parámetros que debían indicarse en la URL.Por ejemplo: 'users/:id' para acceder al perfil de un usuario determinado.</li>
            <li>Antes de ejecutar cada ruta se pasa una función de autenticación para validar si el usuario tiene permisos</li>
            <li>Por último, se exportaron las rutas para que sean utilizadas por el Endpoint principal: 'http://localhost:5000'</li>
        </ul>
        <label class="button" for="verRoutes">Ver ejemplo...</label>
                <input type="checkbox" id="verRoutes">
                <pre class="mostrar">
            <i class="orange"> src/routes/user.js </i>
                    <i class="orange"> /* dependencies */ </i>
                    const express = require(`express`)
                    const router = express.Router()
                <i class="orange"> /* autentication & controller */ </i>
                    const userController = require(`../controller/user`)
                    const { authToken, adminAuth } = require(`../middleware/auth`)
                
                <i class="orange"> /* User routes */ </i>
                    router.post   ( `/`,     adminAuth,  userController.create  ) // C
                    router.get    ( `/`,     adminAuth,  userController.list    ) // R
                    router.get    ( `/:id`,  authToken,  userController.find    ) // R
                    router.put    ( `/:id`,  authToken,  userController.update  ) // U
                    router.delete ( `/:id`,  authToken,  userController.delete  ) // D
                <i class="orange"> /* export user Routes */ </i>
                    module.exports = router
            <i class="orange"> index.js </i>
                <i class="orange"> /* Dependencias */ </i>
                    const express = require(`express`)
                    const swaggerJsDoc = require(`swagger-jsdoc`);
                    const swaggerUi = require(`swagger-ui-express`);
                <i class="orange"> /* Parametros */ </i>
                    const delilah = express()
                    const app = require(`./package.json`)
                    const port = process.env.PORT || 5000
                <i class="orange"> /* Importacion Rutas */ </i>
                    const user = require(`./src/routes/user`)
                    const product = require(`./src/routes/product`)
                    const cart = require(`./src/routes/cart`)
                    const order = require(`./src/routes/order`)
                    const { login, signup } = require(`./src/middleware/auth`)
                <i class="orange"> /* Configuracion API, DOC */ </i>
                    delilah.use(express.urlencoded({ extended: true }))
                    delilah.use(express.json())
                    delilah.listen(port, () => { console.log(`El puerto utilizado es: ${port}.`) });
                <i class="orange"> /* Endpoints */ </i>
                    delilah.get(`/`, (req, res) => { res.send( {
                        tittle: app.name,
                        message: `Bienvenido a ${app.name}, comienza realizando un pedido.`,
                        autor: app.author,
                        version: app.version,
                        documentacion: `http://localhost:5000/api-docs/`
                    } ) } )
                    delilah.use(`/api-docs`, swaggerUi.serve, swaggerUi.setup(swaggerDocs)); // Ruta Documentación Swagger.
                    delilah.use(`/signup`, signup) // Registro de usuario.
                    delilah.use(`/login`, login) // Inicio de sesión.
                    delilah.use(`/users`, user) // Perfiles de usuario.
                    delilah.use(`/products`, product) // Venta de productos.
                    delilah.use(`/cart`, cart) // Carrito de compras.
                    delilah.use(`/orders`, order) // Órdenes de compra.
                </pre>
    </section>
    <section id="auth">
        <h2>Autenticación</h2>
        <p>Para impedir que cualquier usuario ingrese a las diferentes opciones de la aplicación se realiza una validación con JWT donde el usuario deberá iniciar sesión para luego recibir el token correspondiente</p>
        <ul>
            <li>Antes de poder acceder el usuario debe iniciar la sesión o registrarse. En el primer caso, se corroboran los datos del usuario y la contraseña para la generación del token; en el segundo caso se crea el token y se registra el usuario simultáneamente.</li>
            <li>Luego, cuando el servidor responde recibimos el token que se debe almacenar temporalmente. Por cada operación que hagamos el servidor decodificará el token y verificará el ID de usuario y si éste es administador.</li>
            <li>Por último, si el sevidor valida el rol de administrador concede el acceso, en caso de los usuarios convencionales sólo garantizará el acceso si el ID del token coincide con el ID de la ruta. En caso contrario se envía una respuesta 403 (Forbidden)</li>
        </ul>
        <label class="button" for="verAuth">Ver ejemplo...</label>
            <input type="checkbox" id="verAuth">
            <pre class="mostrar">
        <i class="orange">/*  JWT token creation */ </i>
            exports.login = (req, res) =>{
                User.login( req.body.user, req.body.pass,(err, userToken) => {
                    ( userToken[0] ) ? jwt.sign( { userToken }, secret, {expiresIn: `24h`}, (err, token) =>  { 
                        res.json( token ) 
                    } ) : res.status(404).send({
                        error: 404,
                        message: `Usuario y/o contraseña incorrectos.`
                    }   )
            }   )   }  
        <i class="orange">/*  JWT validation access */ </i>
            exports.auth = (req, res, next) =>{
                const bearer = req.headers[`authorization`]
                if(typeof bearer !== `undefined`) { 
                    const token   = bearer.split(` `)[1]; 
                    const decoded = jwt.verify(token, secret);
                    req.token     = token;
                    next()
                } else {
                    accessDenied()
                }
            }
        </pre>
    </section>
    <footer id="footer">
        <address>
            <strong>&copy; Jonathan Kim | </strong>
            <a href="mailto:jonathankim86@gmail.com">jonathankim86@gmail.com</a>
        </address>
    </footer>
</body>
</html>